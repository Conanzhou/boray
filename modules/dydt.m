% Hua-sheng XIE, huashengxie@gmail.com, ENN, 2021-05-02 20:12 
% Right hand side of ray tracing 
% 21-05-14 08:02 jnew=1, remove singularity at omega~omega_cs, *Ya^2
% 21-05-16 07:37 update, to treat if several species have the same singularity
% 21-05-17 15:25 add jnew=2, remove singularity at omega~omega_cs, *Ya^1
function [kpar,kper2,dFdr,dFdphi,dFdz,dFdkr,dFdnphi,dFdkz,dFdw,D]=dydt(...
    r,phi,z,kr,nphi,kz,...
    B,Br,Bz,Bphi,ns0,dBdr,dBdz,dBrdr,dBrdz,dBzdr,dBzdz,...
    dBphidr,dBphidz,dns0dr,dns0dz,qs,ms,w,c2)

epsilon0=8.854187817e-12;
w2=w*w;

%%
kpar=(kr*Br+kz*Bz+nphi/r*Bphi)/B; % k_parallel
kpar2=kpar^2;
k2=kr^2+kz^2+nphi^2/r^2; % k^2
kper2=k2-kpar2; % k_perp^2
% kper=sqrt(kper2)
%%

dkpardr=-kpar/B*dBdr+(kr*dBrdr+kz*dBzdr+nphi/r*dBphidr-Bphi*nphi/r^2)/B;
dkpardz=-kpar/B*dBdz+(kr*dBrdz+kz*dBzdz+nphi/r*dBphidz)/B;

wcs=qs.*B./ms; % gyro frequency
wps2=ns0.*qs.^2./(epsilon0*ms);
% wps=sqrt(wps2); % plasma frequency

dwps2dr=dns0dr.*qs.^2./(epsilon0*ms);
dwps2dz=dns0dz.*qs.^2./(epsilon0*ms);
dwcsdr=qs./ms.*dBdr;
dwcsdz=qs./ms.*dBdz;

% 21-05-17 21:45 remove the singularity when ns0=0
ind=find(ns0~=0);
wcs=wcs(ind); wps2=wps2(ind); dwps2dr=dwps2dr(ind); dwps2dz=dwps2dz(ind);
dwcsdr=dwcsdr(ind); dwcsdz=dwcsdz(ind);

jnew=2;
jdt=1;
if(jnew==0)
% 21-05-13 20:07
Ycs=abs(1-wcs.^2/w2);
% ind=find();
wcs(Ycs<1e-4)=wcs(Ycs<1e-4)*(1+1e-3);

% for Stix notation, eps1=S, eps2=D, eps3=P
eps1=1-sum(wps2./(w2-wcs.^2));
eps2=sum((wcs./w).*wps2./(w2-wcs.^2));
eps3=1-sum(wps2./w2);
D=eps1*(kper2*c2/w2)^2-...
    ((eps1+eps3)*(eps1-kpar2*c2/w2)-eps2^2)*kper2*c2/w2+...
    eps3*((eps1-kpar2*c2/w2)^2-eps2^2);

deps1dr=-sum(dwps2dr./(w2-wcs.^2))-...
    2*sum(wps2./(w2-wcs.^2).^2.*wcs.*dwcsdr);
deps1dz=-sum(dwps2dz./(w2-wcs.^2))-...
    2*sum(wps2./(w2-wcs.^2).^2.*wcs.*dwcsdz);
deps2dr=sum((dwcsdr./w).*wps2./(w2-wcs.^2))+...
    sum((wcs/w).*dwps2dr./(w2-wcs.^2))+...
    2*sum((wcs./w).*wps2./(w2-wcs.^2).^2.*wcs.*dwcsdr);
deps2dz=sum((dwcsdz./w).*wps2./(w2-wcs.^2))+...
    sum((wcs/w).*dwps2dz./(w2-wcs.^2))+...
    2*sum((wcs./w).*wps2./(w2-wcs.^2).^2.*wcs.*dwcsdz);
deps3dr=-sum(dwps2dr./w2);
deps3dz=-sum(dwps2dz./w2);

dDdkpar2=kper2*(c2/w2)^2*(eps1+eps3)-2*eps3*(eps1-kpar2*c2/w2)*c2/w2; % 21-03-31 14:00 fixed a bug
dDdkper2=2*eps1*kper2*(c2/w2)^2-...
    ((eps1+eps3)*(eps1-kpar2*c2/w2)-eps2^2)*c2/w2;
dDdr=deps1dr*(kper2*c2/w2)^2-((deps1dr+deps3dr)*(eps1-kpar2*c2/w2)+...
    (eps1+eps3)*deps1dr-2*eps2*deps2dr)*kper2*c2/w2+...
    deps3dr*((eps1-kpar2*c2/w2)^2-eps2^2)+...
    2*eps3*((eps1-kpar2*c2/w2)*deps1dr-eps2*deps2dr);
dDdz=deps1dz*(kper2*c2/w2)^2-((deps1dz+deps3dz)*(eps1-kpar2*c2/w2)+...
    (eps1+eps3)*deps1dz-2*eps2*deps2dz)*kper2*c2/w2+...
    deps3dz*((eps1-kpar2*c2/w2)^2-eps2^2)+...
    2*eps3*((eps1-kpar2*c2/w2)*deps1dz-eps2*deps2dz);

dFdkr=2*(dDdkpar2-dDdkper2)*kpar*Br/B+2*dDdkper2*kr;
dFdnphi=2*(dDdkpar2-dDdkper2)*kpar*Bphi/(r*B)+2*dDdkper2*nphi/r^2;
dFdkz=2*(dDdkpar2-dDdkper2)*kpar*Bz/B+2*dDdkper2*kz;
dFdr=dDdr+2*(dDdkpar2-dDdkper2)*kpar*dkpardr-2*dDdkper2*nphi^2/r^3;
dFdphi=0;
dFdz=dDdz+2*(dDdkpar2-dDdkper2)*kpar*dkpardz;

if(jdt==0) % use tau
    dFdw=1;
%     dt=1e-3*dt0;
else % use real time t
    deps1dw=2*w*sum(wps2./(w2-wcs.^2).^2);
    deps2dw=-sum(wcs./w2.*wps2./(w2-wcs.^2))-...
        2*sum(wps2./(w2-wcs.^2).^2.*wcs);
    deps3dw=2*sum(wps2./w^3);
    
    dFdw=-4*eps1*(kper2*c2/w2)^2/w+deps1dw*(kper2*c2/w2)^2+...
        2*((eps1+eps3)*(eps1-kpar2*c2/w2)-eps2^2)*kper2*c2/w2/w-...
        ((deps1dw+deps3dw)*(eps1-kpar2*c2/w2)+...
        (eps1+eps3)*(deps1dw+2*kpar2*c2/w2/w)-...
        2*eps2*deps2dw)*kper2*c2/w2+...
        deps3dw*((eps1-kpar2*c2/w2)^2-eps2^2)+...
        2*eps3*((eps1-kpar2*c2/w2)*(deps1dw+2*kpar2*c2/w2/w)-... % fixed a bug +/-, 21-04-07 10:35
        eps2*deps2dw);
end
elseif(jnew==1) % 21-05-14 08:02 remove singularity at omega~omega_cs, *Ya^2
    
% for Stix notation, eps1=S', eps2=D', eps3=P
Ys=abs(1-wcs.^2/w2);
ja=find(Ys==min(Ys));
ja1=ja(1); % 21-05-16 07:40 update, to treat if two species have the same singularity
jb=find(Ys>min(Ys));
Ya=(1-wcs(ja1)^2/w2);

eps1=(Ya-sum(wps2(ja))/w2)-Ya*sum(wps2(jb)./(w2-wcs(jb).^2));
eps2=Ya*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+sum((wcs(ja)/w^3).*wps2(ja));
% eps1=1-sum(wps2./(w2-wcs.^2));
% eps2=sum((wcs./w).*wps2./(w2-wcs.^2));
eps3=1-sum(wps2./w2);
D=Ya*eps1*(kper2*c2/w2)^2-...
    ((eps1+Ya*eps3)*(eps1-Ya*kpar2*c2/w2)-eps2^2)*kper2*c2/w2+...
    eps3*((eps1-Ya*kpar2*c2/w2)^2-eps2^2);

dYadr=-2*wcs(ja1)*dwcsdr(ja1)/w2;
dYadz=-2*wcs(ja1)*dwcsdz(ja1)/w2;
deps1dr=dYadr-sum(dwps2dr(ja)/w2)-...
    Ya*(sum(dwps2dr(jb)./(w2-wcs(jb).^2))+...
    2*sum(wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdr(jb)))-...
    dYadr*sum(wps2(jb)./(w2-wcs(jb).^2));
deps1dz=dYadz-sum(dwps2dz(ja)/w2)-...
    Ya*(sum(dwps2dz(jb)./(w2-wcs(jb).^2))+...
    2*sum(wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdz(jb)))-...
    dYadz*sum(wps2(jb)./(w2-wcs(jb).^2));
deps2dr=Ya*(sum((dwcsdr(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+...
    sum((wcs(jb)/w).*dwps2dr(jb)./(w2-wcs(jb).^2))+...
    2*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdr(jb)))...
    +dYadr*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+...
    sum(dwcsdr(ja).*wps2(ja)+wcs(ja).*dwps2dr(ja))/w^3;
deps2dz=Ya*(sum((dwcsdz(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+...
    sum((wcs(jb)/w).*dwps2dz(jb)./(w2-wcs(jb).^2))+...
    2*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdz(jb)))...
    +dYadz*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+...
    sum(dwcsdz(ja).*wps2(ja)+wcs(ja).*dwps2dz(ja))/w^3;
deps3dr=-sum(dwps2dr./w2);
deps3dz=-sum(dwps2dz./w2);

dDdkpar2=Ya*kper2*(c2/w2)^2*(eps1+Ya*eps3)-...
    2*eps3*(eps1-Ya*kpar2*c2/w2)*Ya*c2/w2; % 21-03-31 14:00 fixed a bug
dDdkper2=2*eps1*Ya*kper2*(c2/w2)^2-...
    ((eps1+Ya*eps3)*(eps1-Ya*kpar2*c2/w2)-eps2^2)*c2/w2;
dDdr=(deps1dr*Ya+dYadr*eps1)*(kper2*c2/w2)^2-...
    ((deps1dr+Ya*deps3dr+dYadr*eps3)*(eps1-Ya*kpar2*c2/w2)+...
    (eps1+Ya*eps3)*(deps1dr-dYadr*kpar2*c2/w2)-2*eps2*deps2dr)*kper2*c2/w2+...
    deps3dr*((eps1-Ya*kpar2*c2/w2)^2-eps2^2)+...
    2*eps3*((eps1-Ya*kpar2*c2/w2)*(deps1dr-dYadr*kpar2*c2/w2)-eps2*deps2dr);
dDdz=(deps1dz*Ya+dYadz*eps1)*(kper2*c2/w2)^2-...
    ((deps1dz+Ya*deps3dz+dYadz*eps3)*(eps1-Ya*kpar2*c2/w2)+...
    (eps1+Ya*eps3)*(deps1dz-dYadz*kpar2*c2/w2)-2*eps2*deps2dz)*kper2*c2/w2+...
    deps3dz*((eps1-Ya*kpar2*c2/w2)^2-eps2^2)+...
    2*eps3*((eps1-Ya*kpar2*c2/w2)*(deps1dz-dYadz*kpar2*c2/w2)-eps2*deps2dz);

dFdkr=2*(dDdkpar2-dDdkper2)*kpar*Br/B+2*dDdkper2*kr;
dFdnphi=2*(dDdkpar2-dDdkper2)*kpar*Bphi/(r*B)+2*dDdkper2*nphi/r^2;
dFdkz=2*(dDdkpar2-dDdkper2)*kpar*Bz/B+2*dDdkper2*kz;
dFdr=dDdr+2*(dDdkpar2-dDdkper2)*kpar*dkpardr-2*dDdkper2*nphi^2/r^3;
dFdphi=0;
dFdz=dDdz+2*(dDdkpar2-dDdkper2)*kpar*dkpardz;

% jdt=1;
if(jdt==0) % use tau
    dFdw=1;
%     dt=1e-5*dt0;
else % use real time t
    deps1dw=Ya*2*w*sum(wps2(jb)./(w2-wcs(jb).^2).^2)-...
        2*wcs(ja1)^2/w^3*sum(wps2(jb)./(w2-wcs(jb).^2))+...
        2*(wcs(ja1)^2+sum(wps2(ja)))/w^3;
    deps2dw=-Ya*(sum(wcs(jb)./w2.*wps2(jb)./(w2-wcs(jb).^2))+...
        2*sum(wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb)))+...
        2*wcs(ja1)^2/w^3*sum(wcs(jb)./w.*wps2(jb)./(w2-wcs(jb).^2))-...
        3*sum(wcs(ja).*wps2(ja))/w^4;
    deps3dw=2*sum(wps2./w^3);
    dYadw=2*wcs(ja1)^2/w^3;
    
    dFdw=-4*Ya*eps1*(kper2*c2/w2)^2/w+(Ya*deps1dw+dYadw*eps1)*(kper2*c2/w2)^2+...
        2*((eps1+Ya*eps3)*(eps1-Ya*kpar2*c2/w2)-eps2^2)*kper2*c2/w2/w-...
        ((deps1dw+Ya*deps3dw+dYadw*eps3)*(eps1-Ya*kpar2*c2/w2)+...
        (eps1+Ya*eps3)*(deps1dw+2*Ya*kpar2*c2/w2/w-dYadw*kpar2*c2/w2)-...
        2*eps2*deps2dw)*kper2*c2/w2+...
        deps3dw*((eps1-Ya*kpar2*c2/w2)^2-eps2^2)+...
        2*eps3*((eps1-Ya*kpar2*c2/w2)*(deps1dw+2*Ya*kpar2*c2/w2/w-dYadw*kpar2*c2/w2)-... % fixed a bug +/-, 21-04-07 10:35
        eps2*deps2dw);
end    
    
elseif(jnew==2) % 21-05-17 15:25 remove singularity at omega~omega_cs, *Ya^1
    
% for Stix notation, eps1=S', eps2=D', eps3=P
Ys=abs(1-wcs.^2/w2);
ja=find(Ys==min(Ys));
ja1=ja(1); % 21-05-16 07:40 update, to treat if two species have the same singularity
jb=find(Ys>min(Ys));
Ya=(1-wcs(ja1)^2/w2);

eps1=1-sum(wps2(jb)./(w2-wcs(jb).^2));
eps2=sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2));
% eps1=1-sum(wps2./(w2-wcs.^2));
% eps2=sum((wcs./w).*wps2./(w2-wcs.^2));
eps3=1-sum(wps2./w2);
G1=Ya*eps1-sum(wps2(ja)/w2);
G2=Ya*(eps1+eps3)*(eps1-kpar2*c2/w2)-sum(wps2(ja)/w2)*(2*eps1+...
    eps3-kpar2*c2/w2)-Ya*eps2^2-2*eps2*sum(wcs(ja).*wps2(ja)/w2/w)+...
    sum(wps2(ja)/w2)^2;
G3=eps3*(Ya*(eps1-kpar2*c2/w2)^2-2*sum(wps2(ja)/w2)*(eps1-kpar2*c2/w2)-...
    Ya*eps2^2-2*eps2*sum(wcs(ja).*wps2(ja)/w2/w)+sum(wps2(ja)/w2)^2);
D=G1*(kper2*c2/w2)^2-G2*kper2*c2/w2+G3;

dYadr=-2*wcs(ja1)*dwcsdr(ja1)/w2;
dYadz=-2*wcs(ja1)*dwcsdz(ja1)/w2;
deps1dr=-sum(dwps2dr(jb)./(w2-wcs(jb).^2))-...
    2*sum(wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdr(jb));
deps1dz=-sum(dwps2dz(jb)./(w2-wcs(jb).^2))-...
    2*sum(wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdz(jb));
deps2dr=sum((dwcsdr(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+...
    sum((wcs(jb)/w).*dwps2dr(jb)./(w2-wcs(jb).^2))+...
    2*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdr(jb));
deps2dz=sum((dwcsdz(jb)./w).*wps2(jb)./(w2-wcs(jb).^2))+...
    sum((wcs(jb)/w).*dwps2dz(jb)./(w2-wcs(jb).^2))+...
    2*sum((wcs(jb)./w).*wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb).*dwcsdz(jb));
deps3dr=-sum(dwps2dr./w2);
deps3dz=-sum(dwps2dz./w2);

% dG1dr=dYadr*eps1+Ya*deps1dr-sum(dwps2dr(ja)/w2)^2;
% dG1dz=dYadz*eps1+Ya*deps1dz-sum(dwps2dz(ja)/w2)^2;
dG1dr=dYadr*eps1+Ya*deps1dr-sum(dwps2dr(ja)/w2); % 21-05-17 18:59 fix bug
dG1dz=dYadz*eps1+Ya*deps1dz-sum(dwps2dz(ja)/w2);
dG2dr=(dYadr*(eps1+eps3)+Ya*(deps1dr+deps3dr))*(eps1-kpar2*c2/w2)+...
    Ya*(eps1+eps3)*deps1dr-sum(dwps2dr(ja)/w2)*(2*eps1+eps3-kpar2*c2/w2)-...
    sum(wps2(ja)/w2)*(2*deps1dr+deps3dr)-dYadr*eps2^2-2*Ya*deps2dr*eps2-...
    2*deps2dr*sum(wcs(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(dwcsdr(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(wcs(ja).*dwps2dr(ja)/w2/w)+...
    2*sum(dwps2dr(ja)/w2)*sum(wps2(ja)/w2);
dG2dz=(dYadz*(eps1+eps3)+Ya*(deps1dz+deps3dz))*(eps1-kpar2*c2/w2)+...
    Ya*(eps1+eps3)*deps1dz-sum(dwps2dz(ja)/w2)*(2*eps1+eps3-kpar2*c2/w2)-...
    sum(wps2(ja)/w2)*(2*deps1dz+deps3dz)-dYadz*eps2^2-2*Ya*deps2dz*eps2-...
    2*deps2dz*sum(wcs(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(dwcsdz(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(wcs(ja).*dwps2dz(ja)/w2/w)+...
    2*sum(dwps2dz(ja)/w2)*sum(wps2(ja)/w2);
dG3dr=deps3dr*(Ya*(eps1-kpar2*c2/w2)^2-...
    2*sum(wps2(ja)/w2)*(eps1-kpar2*c2/w2)-...
    Ya*eps2^2-2*eps2*sum(wcs(ja).*wps2(ja)/w2/w)+sum(wps2(ja)/w2)^2)+...
    eps3*(dYadr*(eps1-kpar2*c2/w2)^2+2*(Ya*deps1dr-...
    sum(dwps2dr(ja)/w2))*(eps1-kpar2*c2/w2)-2*sum(wps2(ja)/w2)*deps1dr-...
    dYadr*eps2^2-2*Ya*deps2dr*eps2-...
    2*deps2dr*sum(wcs(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(dwcsdr(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(wcs(ja).*dwps2dr(ja)/w2/w)+...
    2*sum(dwps2dr(ja)/w2)*sum(wps2(ja)/w2));
dG3dz=deps3dz*(Ya*(eps1-kpar2*c2/w2)^2-...
    2*sum(wps2(ja)/w2)*(eps1-kpar2*c2/w2)-...
    Ya*eps2^2-2*eps2*sum(wcs(ja).*wps2(ja)/w2/w)+sum(wps2(ja)/w2)^2)+...
    eps3*(dYadz*(eps1-kpar2*c2/w2)^2+2*(Ya*deps1dz-...
    sum(dwps2dz(ja)/w2))*(eps1-kpar2*c2/w2)-2*sum(wps2(ja)/w2)*deps1dz-...
    dYadz*eps2^2-2*Ya*deps2dz*eps2-...
    2*deps2dz*sum(wcs(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(dwcsdz(ja).*wps2(ja)/w2/w)-...
    2*eps2*sum(wcs(ja).*dwps2dz(ja)/w2/w)+...
    2*sum(dwps2dz(ja)/w2)*sum(wps2(ja)/w2));

dDdkpar2=kper2*(c2/w2)^2*(Ya*eps1-sum(wps2(ja)/w2)+Ya*eps3)-...
    2*eps3*(Ya*eps1-sum(wps2(ja)/w2)-Ya*kpar2*c2/w2)*c2/w2;
dDdkper2=2*G1*kper2*(c2/w2)^2-G2*c2/w2;
dDdr=dG1dr*(kper2*c2/w2)^2-dG2dr*kper2*c2/w2+dG3dr;
dDdz=dG1dz*(kper2*c2/w2)^2-dG2dz*kper2*c2/w2+dG3dz;

dFdkr=2*(dDdkpar2-dDdkper2)*kpar*Br/B+2*dDdkper2*kr;
dFdnphi=2*(dDdkpar2-dDdkper2)*kpar*Bphi/(r*B)+2*dDdkper2*nphi/r^2;
dFdkz=2*(dDdkpar2-dDdkper2)*kpar*Bz/B+2*dDdkper2*kz;
dFdr=dDdr+2*(dDdkpar2-dDdkper2)*kpar*dkpardr-2*dDdkper2*nphi^2/r^3;
dFdphi=0;
dFdz=dDdz+2*(dDdkpar2-dDdkper2)*kpar*dkpardz;

% jdt=1;
if(jdt==0) % use tau
    dFdw=1;
%     dt=1e-5*dt0;
else % use real time t, to update
    deps1dw=2*w*sum(wps2(jb)./(w2-wcs(jb).^2).^2);
    deps2dw=-(sum(wcs(jb)./w2.*wps2(jb)./(w2-wcs(jb).^2))+...
        2*sum(wps2(jb)./(w2-wcs(jb).^2).^2.*wcs(jb)));
    deps3dw=2*sum(wps2./w^3);
    dYadw=2*wcs(ja1)^2/w^3;
    
    dG1dw=dYadw*eps1+Ya*deps1dw+2*sum(wps2(ja)/w2)/w;
    dG2dw=dYadw*(eps1+eps3)*(eps1-kpar2*c2/w2)+...
        Ya*(deps1dw+deps3dw)*(eps1-kpar2*c2/w2)+...
        Ya*(eps1+eps3)*(deps1dw+2*kpar2*c2/w2/w)-...
        sum(wps2(ja)/w2)*(2*deps1dw+deps3dw+2*kpar2*c2/w2/w)+...
        2*sum(wps2(ja)/w2)/w*(2*eps1+eps3-kpar2*c2/w2)-...
        dYadw*eps2^2-2*Ya*eps2*deps2dw-...
        2*deps2dw*sum(wcs(ja).*wps2(ja)/w2/w)+...
        6*eps2*sum(wcs(ja).*wps2(ja)/w2/w)/w-...
        4*sum(wps2(ja)/w2)*sum(wps2(ja)/w2)/w;
    dG3dw=deps3dw*(Ya*(eps1-kpar2*c2/w2)^2-2*sum(wps2(ja)/w2)*(eps1-kpar2*c2/w2)-...
        Ya*eps2^2-2*eps2*sum(wcs(ja).*wps2(ja)/w2/w)+sum(wps2(ja)/w2)^2)+...
        eps3*(dYadw*(eps1-kpar2*c2/w2)^2+...
        2*(Ya*(eps1-kpar2*c2/w2)-sum(wps2(ja)/w2))*(deps1dw+2*kpar2*c2/w2/w)+...
        4*sum(wps2(ja)/w2)/w*(eps1-kpar2*c2/w2)-...
        dYadw*eps2^2-2*Ya*eps2*deps2dw-...
        2*deps2dw*sum(wcs(ja).*wps2(ja)/w2/w)+...
        6*eps2*sum(wcs(ja).*wps2(ja)/w2/w)/w-...
        4*sum(wps2(ja)/w2)*sum(wps2(ja)/w2)/w);
    
    dFdw=dG1dw*(kper2*c2/w2)^2-4*G1*(kper2*c2/w2)^2/w-...
        dG2dw*kper2*c2/w2+2*G2*kper2*c2/w2/w+dG3dw;
end
end

end